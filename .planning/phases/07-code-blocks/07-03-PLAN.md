---
phase: 07-code-blocks
plan: 03
type: execute
wave: 2
depends_on: ['07-01']
files_modified:
    - src/lib/shiki/transformerCodeBlock.js
    - src/lib/sanity/portable-text/CodeBlock.svelte
    - src/lib/scss/_markdown.scss
autonomous: true

must_haves:
    truths:
        - 'Code blocks support line highlighting via meta syntax (e.g., ```js {1,3-5})'
        - 'Highlighted lines display with subtle background tint'
        - 'Line highlighting works for both single lines and ranges'
    artifacts:
        - path: 'src/lib/shiki/transformerCodeBlock.js'
          provides: 'Line highlight parsing via transformerMetaHighlight integration'
          contains: 'transformerMetaHighlight'
        - path: 'src/lib/sanity/portable-text/CodeBlock.svelte'
          provides: 'Transformer integration in codeToHtml call'
          contains: 'transformers'
        - path: 'src/lib/scss/_markdown.scss'
          provides: 'CSS for .line.highlighted elements'
          contains: '.highlighted'
    key_links:
        - from: 'src/lib/sanity/portable-text/CodeBlock.svelte'
          to: 'src/lib/shiki/transformerCodeBlock.js'
          via: 'transformer import and usage'
          pattern: 'transformerCodeBlock|transformers.*\\['
        - from: 'pre.shiki .line.highlighted'
          to: 'transformerMetaHighlight'
          via: 'CSS class added by transformer'
          pattern: '\\.line\\.highlighted'
---

<objective>
Add line highlighting support for code blocks to enable tutorial-style code emphasis via meta syntax like ```js {1,3-5}.

Purpose: Allow blog posts to highlight specific lines of code for educational content, making it
easier to draw attention to important code sections. Output: Working line highlighting with subtle
background tint on marked lines. </objective>

<execution_context> @./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-code-blocks/07-CONTEXT.md
@.planning/phases/07-code-blocks/07-RESEARCH.md
@src/lib/shiki/transformerCodeBlock.js
@src/lib/sanity/portable-text/CodeBlock.svelte
@src/lib/scss/_markdown.scss
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add line highlight CSS to _markdown.scss</name>
  <files>src/lib/scss/_markdown.scss</files>
  <action>
Add CSS for highlighted lines in the pre.shiki section:

1. Add a new rule inside `pre.shiki` for highlighted lines:

    ```scss
    .line.highlighted {
        background-color: rgba(255, 128, 0, 0.1);
        display: block;
        margin: 0 -1em;
        padding: 0 1em;
        border-left: 2px solid rgba(255, 128, 0, 0.5);
    }
    ```

2. Place this rule after the existing `.line` rule (around line 148-152).

The highlight uses orange tint (matching the accent color) with subtle background and left border
indicator. The negative margin and padding extend the highlight to the edges of the code block.

Note: The `.highlighted` class is added by Shiki's transformerMetaHighlight when lines are specified
in meta syntax. </action> <verify> `grep -n "\.highlighted" src/lib/scss/_markdown.scss` shows the
new rule. `npm run check` passes. </verify> <done> CSS for .line.highlighted exists with
orange-tinted background and left border. </done> </task>

<task type="auto">
  <name>Task 2: Integrate transformerMetaHighlight in Sanity CodeBlock</name>
  <files>src/lib/sanity/portable-text/CodeBlock.svelte</files>
  <action>
Update the Sanity CodeBlock component to use transformers for line highlighting:

1. Add import for transformerMetaHighlight:

    ```typescript
    import { transformerMetaHighlight } from '@shikijs/transformers';
    ```

2. Update the codeToHtml call to include transformers:

    ```typescript
    codeToHtml(code, {
        lang,
        theme: 'ayu-dark',
        transformers: [
            transformerMetaHighlight({
                className: 'highlighted',
            }),
        ],
        meta: value.highlightedLines ? { __raw: value.highlightedLines } : undefined,
    }).then((html) => {
        highlightedHtml = html;
    });
    ```

3. The `value.highlightedLines` field already exists in the CodeBlockValue interface (see line 11).
   This field comes from Sanity and can contain syntax like "{1,3-5}" for line highlighting.

4. If highlightedLines is provided, pass it as meta.\_\_raw so transformerMetaHighlight can parse
   it.

Note: The Sanity schema already has a highlightedLines field. This wires up the frontend to use it.
</action> <verify> `npm run check` passes. Grep for transformer usage:
`grep -n "transformerMetaHighlight\|transformers" src/lib/sanity/portable-text/CodeBlock.svelte`
</verify> <done> Sanity CodeBlock uses transformerMetaHighlight with highlightedLines from Sanity
schema. </done> </task>

<task type="auto">
  <name>Task 3: Verify line highlighting works end-to-end</name>
  <files></files>
  <action>
Verify the line highlighting integration works:

1. Run `npm run build` to ensure no build errors.

2. Run `npm run test` to ensure no test regressions.

3. For full verification, line highlighting can be tested by:
    - Adding a code block in Sanity with highlightedLines set (e.g., "{1,3}")
    - Or by creating a test case

Since this is a Sanity-driven feature, the CSS and transformer are ready. Actual usage requires
Sanity content with highlightedLines field populated.

4. The feature is wired up and ready for use. Blog authors can now add line highlighting to code
   blocks via the Sanity Studio. </action> <verify> `npm run build` passes. `npm run test` passes.
   Feature code is in place - CSS + transformer integration complete. </verify> <done> Line
   highlighting feature complete: CSS, transformer integration, ready for Sanity content. </done>
   </task>

</tasks>

<verification>
After all tasks complete:
1. `npm run check` passes
2. `npm run build` passes
3. `npm run test` passes
4. CSS for .line.highlighted exists in _markdown.scss
5. transformerMetaHighlight is imported and used in Sanity CodeBlock
6. highlightedLines field is passed to transformer as meta
</verification>

<success_criteria>

- CODE-06: Line highlighting support for tutorials
- CSS defines subtle orange-tinted background for highlighted lines
- Transformer integration ready for Sanity content with highlightedLines
- Build passes, no regressions </success_criteria>

<output>
After completion, create `.planning/phases/07-code-blocks/07-03-SUMMARY.md`
</output>
