---
phase: 03-migration
plan: 02
type: execute
wave: 2
depends_on: ['03-01']
files_modified:
    - studio/schemas/documents/gem.ts
    - scripts/migrate-gems-to-sanity.js
    - src/lib/sanity/queries.ts
    - src/routes/gems/+page.server.ts
    - src/lib/components/molecules/GemCard.svelte
autonomous: true

must_haves:
    truths:
        - 'All 3 gems exist in Sanity with cover images'
        - 'Gems page displays gems from Sanity with correct images'
        - 'Gem cover images load from Sanity CDN'
    artifacts:
        - path: 'studio/schemas/documents/gem.ts'
          provides: 'Gem schema with coverImage field'
          contains: 'coverImage'
        - path: 'scripts/migrate-gems-to-sanity.js'
          provides: 'Gem migration script'
          contains: 'migrateGem'
        - path: 'src/lib/sanity/queries.ts'
          provides: 'allGemsQuery GROQ query'
          contains: 'allGemsQuery'
        - path: 'src/routes/gems/+page.server.ts'
          provides: 'Server loader fetching from Sanity'
          contains: 'allGemsQuery'
    key_links:
        - from: 'src/routes/gems/+page.server.ts'
          to: 'src/lib/sanity/queries.ts'
          via: 'import allGemsQuery'
          pattern: 'import.*allGemsQuery'
        - from: 'src/lib/components/molecules/GemCard.svelte'
          to: 'Sanity CDN'
          via: 'coverImage.url prop'
          pattern: "coverImage\\.url"
---

<objective>
Migrate all gems to Sanity and update gems page to fetch from Sanity.

Purpose: Complete gem migration (MIGR-03, SLCE-03) so gems serve from Sanity CMS Output: 3 gems in
Sanity with cover images, gems page fetching from Sanity </objective>

<execution_context> @./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-migration/03-CONTEXT.md
@.planning/phases/03-migration/03-RESEARCH.md
@.planning/phases/03-migration/03-01-SUMMARY.md

# Current gem implementation

@src/lib/data/gems/index.ts @src/routes/gems/+page.server.ts @src/routes/gems/+page.svelte
@src/lib/components/molecules/GemCard.svelte

# Gem schema (needs coverImage)

@studio/schemas/documents/gem.ts

# Existing query patterns

@src/lib/sanity/queries.ts </context>

<tasks>

<task type="auto">
  <name>Task 1: Add coverImage to gem schema and deploy Studio</name>
  <files>studio/schemas/documents/gem.ts</files>
  <action>
Add coverImage field to gem schema. The gem schema currently lacks this field but the GemCard component requires it.

In `studio/schemas/documents/gem.ts`, add after the `tags` field:

```typescript
defineField({
  name: 'coverImage',
  title: 'Cover Image',
  type: 'image',
  options: {
    hotspot: true,
  },
  fields: [
    defineField({
      name: 'alt',
      title: 'Alt Text',
      type: 'string',
      description: 'Describe the image for accessibility',
    }),
  ],
}),
```

Deploy updated schema:

```bash
cd studio && npm run deploy
```

  </action>
  <verify>
```bash
cd studio && npm run build  # Validates schema
```
Check Studio at https://hvsy54ho.sanity.studio - gem document type should show coverImage field.
  </verify>
  <done>Gem schema includes coverImage field with hotspot support</done>
</task>

<task type="auto">
  <name>Task 2: Create gem migration script and migrate gems</name>
  <files>scripts/migrate-gems-to-sanity.js</files>
  <action>
Create a new migration script for gems based on the post migration pattern.

Create `scripts/migrate-gems-to-sanity.js`:

1. Read gems from `src/lib/data/gems/index.ts` (import directly or parse)
2. For each gem:
    - Resolve `$assets` alias to `src/lib/assets`
    - Upload coverImage to Sanity CDN
    - Find or create tags (reuse tag logic from post migration)
    - Create gem document with `createOrReplace` using ID `gem-${slugify(title)}`
3. Generate slug from title using slugify (gems use title-based slugs)

Per RESEARCH.md gem inventory:

- YouTube Channel: LifeHack Automations -> lifehack-automations.png
- YouTube Channel: Kie Codes -> kie-codes.png
- YouTube Channel: Catangle -> catangle.png

Add npm script to package.json:

```json
"migrate:gems": "node --env-file=.env.local scripts/migrate-gems-to-sanity.js"
```

Run migration:

```bash
npm run migrate:gems
```

  </action>
  <verify>
```bash
# Count gems in Sanity (should be 3)
curl "https://hvsy54ho.api.sanity.io/v2024-01-01/data/query/production?query=count(*[_type==\"gem\"])"
```
  </verify>
  <done>3 gems migrated to Sanity with cover images and tags</done>
</task>

<task type="auto">
  <name>Task 3: Update gems page to fetch from Sanity</name>
  <files>src/lib/sanity/queries.ts, src/routes/gems/+page.server.ts, src/lib/components/molecules/GemCard.svelte</files>
  <action>
Wire gems page to Sanity instead of local TypeScript file.

1. Add GROQ query to `src/lib/sanity/queries.ts`:

```typescript
export const allGemsQuery = defineQuery(`
  *[_type == "gem"] | order(title asc) {
    _id,
    title,
    "slug": slug.current,
    url,
    description,
    tags[]-> {
      name,
      "slug": slug.current
    },
    coverImage {
      alt,
      asset,
      "url": asset->url,
      "lqip": asset->metadata.lqip
    }
  }
`);
```

2. Update `src/routes/gems/+page.server.ts`:

```typescript
import { client } from '$lib/sanity/client';
import { allGemsQuery } from '$lib/sanity/queries';

export async function load({ setHeaders }) {
    setHeaders({
        'cache-control': 'public, max-age=43200', // 12 hours
    });

    const gems = await client.fetch(allGemsQuery);

    // Rotate array by day of week (preserve existing behavior)
    const day = new Date().getDay();
    const rotated = rotateArray(gems, day);

    return { gems: rotated };
}
```

3. Update `GemCard.svelte` to support Sanity CDN images:

- Accept `coverImage` as either string (legacy) or object with `url` (Sanity)
- Remove import.meta.glob for local images (no longer needed after migration)
- Use Sanity CDN URL directly when available

The component should handle:

```typescript
interface Props {
    coverImage: string | { url?: string; alt?: string; lqip?: string };
}
```

  </action>
  <verify>
```bash
npm run dev &
curl -s http://localhost:5173/gems | grep -q "cdn.sanity.io"  # Images from Sanity CDN
```
  </verify>
  <done>Gems page fetches from Sanity, images load from Sanity CDN</done>
</task>

</tasks>

<verification>
- [ ] Gem schema has coverImage field (check Studio)
- [ ] 3 gems exist in Sanity with cover images
- [ ] Gems page renders with Sanity data
- [ ] Cover images load from cdn.sanity.io
- [ ] Day-based rotation still works
</verification>

<success_criteria>

- Gem schema updated with coverImage field
- All 3 gems migrated to Sanity with images
- Gems page fetches exclusively from Sanity
- Cover images served from Sanity CDN </success_criteria>

<output>
After completion, create `.planning/phases/03-migration/03-02-SUMMARY.md`
</output>
