---
phase: 03-migration
plan: 03
type: execute
wave: 3
depends_on: ['03-01', '03-02']
files_modified:
    - src/routes/[slug]/+page.server.ts
    - src/routes/blog/+page.server.ts
    - src/lib/server/posts.ts
    - src/lib/data/posts.ts
    - src/lib/data/gems/index.ts
    - src/content/blog/
    - src/lib/assets/images/posts/
    - src/lib/assets/images/gems/
autonomous: false

must_haves:
    truths:
        - 'All content serves exclusively from Sanity (no markdown fallback)'
        - 'Old markdown files are removed from repository'
        - 'All URLs continue to work unchanged'
    artifacts:
        - path: 'src/routes/[slug]/+page.server.ts'
          provides: 'Sanity-only post loading'
          contains: 'postBySlugQuery'
        - path: 'src/routes/blog/+page.server.ts'
          provides: 'Sanity-only listing'
          contains: 'allPostsQuery'
    key_links:
        - from: 'src/routes/[slug]/+page.server.ts'
          to: 'src/lib/sanity/client.ts'
          via: 'Sanity client import'
          pattern: 'import.*client.*from.*sanity'
---

<objective>
Remove dual-source routing and delete old markdown content system.

Purpose: Complete migration cutover (MIGR-05) - all content from Sanity, old system removed Output:
Simplified codebase with Sanity as sole content source </objective>

<execution_context> @./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-migration/03-CONTEXT.md
@.planning/phases/03-migration/03-01-SUMMARY.md
@.planning/phases/03-migration/03-02-SUMMARY.md

# Current dual-source routing

@src/routes/[slug]/+page.server.ts @src/routes/blog/+page.server.ts

# Old content system to remove

@src/lib/server/posts.ts @src/lib/data/posts.ts @src/lib/data/gems/index.ts @src/content/blog/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify routing to Sanity-only</name>
  <files>src/routes/[slug]/+page.server.ts, src/routes/blog/+page.server.ts</files>
  <action>
Remove dual-source routing - all content now comes from Sanity.

1. Update `src/routes/[slug]/+page.server.ts`:

```typescript
import type { PageServerLoad } from './$types';
import { client, previewClient } from '$lib/sanity/client';
import { postBySlugQuery } from '$lib/sanity/queries';
import { error } from '@sveltejs/kit';
import { env } from '$env/dynamic/private';

export const load: PageServerLoad = async ({ params, url }) => {
    const previewSecret = env.SANITY_PREVIEW_SECRET;
    const isPreview = previewSecret && url.searchParams.get('preview') === previewSecret;
    const sanityClient = isPreview ? previewClient : client;

    const post = await sanityClient.fetch(postBySlugQuery, { slug: params.slug });

    if (!post) {
        throw error(404, 'Post not found');
    }

    return {
        source: 'sanity' as const,
        post,
    };
};
```

2. Update `src/routes/blog/+page.server.ts`:

- Remove markdown imports (`filteredPosts`, `markdownPosts`)
- Remove deduplication logic (no longer needed)
- Keep only Sanity fetch
- Preserve MetaTagsProps and cache headers

The simplified version:

```typescript
import type { PageServerLoad } from './$types';
import type { MetaTagsProps } from 'svelte-meta-tags';
import { client } from '$lib/sanity/client';
import { allPostsQuery } from '$lib/sanity/queries';

export const load: PageServerLoad = async () => {
    const sanityPosts = await client.fetch(allPostsQuery);

    const posts = sanityPosts.map((p) => ({
        slug: p.slug,
        title: p.title,
        excerpt: p.excerpt,
        date: p.date,
        tags: p.tags?.map((t) => t.name) ?? [],
        source: 'sanity' as const,
        coverImage: p.coverImage,
    }));

    const pageMetaTags = Object.freeze({
        title: 'Blog',
        description: 'DevOps insights, cloud infrastructure tutorials...',
        // ... keep existing meta tags
    }) satisfies MetaTagsProps;

    return { posts, pageMetaTags };
};
```

  </action>
  <verify>
```bash
npm run dev &
# Test post routing (should work, Sanity-only)
curl -s http://localhost:5173/2023-12-11-deploy-sops-secrets-with-nix | grep -q "SOPS"
# Test listing (should work, Sanity-only)
curl -s http://localhost:5173/blog | grep -q "blog-post-card"
```
  </verify>
  <done>Routing simplified to Sanity-only, no markdown fallback</done>
</task>

<task type="auto">
  <name>Task 2: Remove old content system files</name>
  <files>src/lib/server/posts.ts, src/lib/data/posts.ts, src/lib/data/gems/index.ts, src/content/blog/, src/lib/assets/images/posts/, src/lib/assets/images/gems/</files>
  <action>
Delete the old markdown content system that is no longer used.

Per CONTEXT.md: "Delete old markdown files after successful cutover" Per ROADMAP Phase 4: These will
be deleted, but Phase 4 handles RSS/sitemap. Clean files now.

Files to delete:

```bash
# Old content loaders (no longer imported after Task 1)
rm src/lib/server/posts.ts
rm src/lib/data/posts.ts
rm -r src/lib/data/gems/  # Entire gems directory

# Old content files
rm -r src/content/blog/

# Old local images (now on Sanity CDN)
rm -r src/lib/assets/images/posts/
rm -r src/lib/assets/images/gems/
```

Update any remaining imports that might reference deleted files:

- Check for imports of `$lib/server/posts` - should be none after Task 1
- Check for imports of `$lib/data/posts` - should be none after Task 1
- Check for imports of `$lib/data/gems` - should be none after 03-02

If `src/lib/data/` directory becomes empty except for `authors.ts` and `meta.ts`, keep those.
</action> <verify>

```bash
# Verify files are deleted
test ! -f src/lib/server/posts.ts && echo "posts.ts removed"
test ! -d src/content/blog && echo "blog content removed"
test ! -d src/lib/assets/images/posts && echo "post images removed"

# Verify build still works
npm run build
```

  </verify>
  <done>Old markdown content system removed, only Sanity content remains</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete migration</name>
  <what-built>
Complete Sanity migration with dual-source routing removed and old files deleted.
All content now served exclusively from Sanity CMS.
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`

2. Verify blog listing at http://localhost:5173/blog:
    - All 9 posts appear (including hidden posts should NOT appear)
    - Posts sorted by date descending
    - Cover images load from cdn.sanity.io

3. Verify individual posts work:
    - http://localhost:5173/2023-12-11-deploy-sops-secrets-with-nix
    - http://localhost:5173/2025-09-03-tdd-infrastructure-terragrunt
    - http://localhost:5173/00-uses
    - Check code blocks render with syntax highlighting
    - Check images load from Sanity CDN

4. Verify gems page at http://localhost:5173/gems:
    - All 3 gems appear with cover images
    - Links work correctly

5. Verify hidden posts are hidden:
    - http://localhost:5173/00-consulting (should 404 or work as expected for hidden)
    - http://localhost:5173/00-impressum (should 404 or work as expected for hidden)

6. Run tests: `npm run test && npm run check` </how-to-verify> <resume-signal>Type "approved" if all
   content renders correctly, or describe issues</resume-signal> </task>

</tasks>

<verification>
- [ ] No imports of `$lib/server/posts` in codebase
- [ ] No imports of `$lib/data/posts` in codebase
- [ ] No imports of `$lib/data/gems` in codebase
- [ ] `src/content/blog/` directory deleted
- [ ] `src/lib/assets/images/posts/` directory deleted
- [ ] `npm run build` succeeds
- [ ] All URLs return correct content
</verification>

<success_criteria>

- Dual-source routing removed from all routes
- Old markdown content system files deleted
- Old image directories deleted
- Build succeeds with Sanity-only content
- Human verification confirms all content accessible </success_criteria>

<output>
After completion, create `.planning/phases/03-migration/03-03-SUMMARY.md`
</output>
