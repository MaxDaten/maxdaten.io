---
phase: 03-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
    - scripts/migrate-post-to-sanity.js
autonomous: true

must_haves:
    truths:
        - 'All 8 remaining blog posts exist in Sanity with correct slugs'
        - 'All post images load from Sanity CDN'
        - 'Posts display correctly at their existing URLs'
    artifacts:
        - path: 'scripts/migrate-post-to-sanity.js'
          provides: 'Batch migration with idempotent createOrReplace'
          contains: 'migrateBatch'
    key_links:
        - from: 'scripts/migrate-post-to-sanity.js'
          to: 'Sanity API'
          via: 'createOrReplace with predictable IDs'
          pattern: 'createOrReplace'
---

<objective>
Migrate all remaining blog posts from markdown to Sanity CMS using batch processing.

Purpose: Complete blog post migration (MIGR-01, MIGR-02, MIGR-04) so all posts serve from Sanity
Output: 8 posts migrated to Sanity with all images on Sanity CDN </objective>

<execution_context> @./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-migration/03-CONTEXT.md
@.planning/phases/03-migration/03-RESEARCH.md

# Existing migration script (extend this)

@scripts/migrate-post-to-sanity.js

# Content to migrate

@src/content/blog/ </context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance migration script for batch processing</name>
  <files>scripts/migrate-post-to-sanity.js</files>
  <action>
Extend the existing migration script to support batch processing:

1. Add `migrateBatch(postPaths)` function that processes multiple posts sequentially
2. Change `client.create()` to `client.createOrReplace()` with predictable IDs (`post-${slug}`)
3. Add skip logic: check if post already exists AND matches content (skip if identical)
4. Add `--batch` CLI flag to process all markdown files in src/content/blog/
5. Add `--skip-migrated` flag (default: true) to skip the already-migrated TDD Infrastructure post
6. Per CONTEXT.md: stop batch on any failure (no continue-on-error)
7. Per CONTEXT.md: console-only logging, no persistent log file

Keep existing single-file migration working (backward compatible).

Example usage:

```bash
node scripts/migrate-post-to-sanity.js --batch
node scripts/migrate-post-to-sanity.js src/content/blog/00-uses.md  # single file still works
```

  </action>
  <verify>
Run `node scripts/migrate-post-to-sanity.js --help` shows batch options.
Run `node scripts/migrate-post-to-sanity.js --batch --dry-run` lists all posts to migrate.
  </verify>
  <done>Migration script supports batch mode with idempotent createOrReplace</done>
</task>

<task type="auto">
  <name>Task 2: Migrate all remaining blog posts</name>
  <files>None (Sanity mutations only)</files>
  <action>
Run the batch migration to migrate all 8 remaining posts to Sanity.

Posts to migrate (per RESEARCH.md inventory):

1. 2023-12-11-deploy-sops-secrets-with-nix (3 images)
2. 2024-05-15-telepresence-google-cloud-kubernetes-engine-gke (1 image)
3. 2025-07-26-check-engine-work-progress-limit-matters (3 images)
4. 2025-07-31-continuous-care-no-to-maintenance-processes (0 images, hidden)
5. 2025-08-09-your-continuous-delivery-transformation-is-not-complete (1 image)
6. 00-uses (2 images)
7. 00-consulting (0 images, hidden)
8. 00-impressum (0 images, hidden)

Skip: 2025-09-03-tdd-infrastructure-terragrunt (already migrated in Phase 2)

Run:

```bash
SANITY_API_TOKEN=<token> node scripts/migrate-post-to-sanity.js --batch
```

Per CONTEXT.md decisions:

- Stop on any failure
- Posts published immediately
- Console logging only </action> <verify> Verify each post exists in Sanity:

```bash
# Count posts in Sanity (should be 9 total: 8 new + 1 from Phase 2)
curl "https://hvsy54ho.api.sanity.io/v2024-01-01/data/query/production?query=count(*[_type==\"post\"])"
```

Verify posts render locally:

```bash
npm run dev &
curl -s http://localhost:5173/2023-12-11-deploy-sops-secrets-with-nix | grep -q "SOPS"
curl -s http://localhost:5173/00-uses | grep -q "Uses"
```

  </verify>
  <done>All 9 posts (1 existing + 8 new) exist in Sanity and render at correct URLs</done>
</task>

</tasks>

<verification>
- [ ] `node scripts/migrate-post-to-sanity.js --batch --dry-run` lists 8 posts (excludes already-migrated)
- [ ] Sanity query returns 9 total posts
- [ ] All migrated posts render at their existing URLs via dev server
- [ ] All images load from Sanity CDN (cdn.sanity.io URLs in page source)
</verification>

<success_criteria>

- 8 additional posts migrated to Sanity (9 total including Phase 2 post)
- All post images uploaded to Sanity CDN
- All slugs preserved exactly
- Migration script enhanced with batch support </success_criteria>

<output>
After completion, create `.planning/phases/03-migration/03-01-SUMMARY.md`
</output>
