---
phase: 04-finalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
    - src/routes/rss.xml/+server.ts
    - src/lib/sanity/queries.ts
    - package.json
autonomous: true

must_haves:
    truths:
        - 'RSS feed at /rss.xml returns valid XML'
        - 'RSS feed contains all published blog posts from Sanity'
        - 'RSS content:encoded contains full HTML body, not plain text'
        - 'Code blocks render as pre/code tags in RSS'
        - 'RSS includes dc:creator author tag for each post'
    artifacts:
        - path: 'src/routes/rss.xml/+server.ts'
          provides: 'RSS feed generation with HTML body'
          contains: 'toHTML'
        - path: 'src/lib/sanity/queries.ts'
          provides: 'RSS-specific GROQ query with body field'
          contains: 'rssPostsQuery'
    key_links:
        - from: 'src/routes/rss.xml/+server.ts'
          to: 'src/lib/sanity/queries.ts'
          via: 'rssPostsQuery import'
          pattern: 'import.*rssPostsQuery'
        - from: 'src/routes/rss.xml/+server.ts'
          to: '@portabletext/to-html'
          via: 'toHTML import'
          pattern: 'import.*toHTML.*@portabletext/to-html'
---

<objective>
Enhance RSS feed to render full HTML body content using @portabletext/to-html

Purpose: RSS readers display rich formatted content instead of plain text, matching CONTEXT.md
decision for "full HTML body content in feed" Output: Working RSS feed at /rss.xml with
HTML-rendered Portable Text body, author tags, and proper code block formatting </objective>

<execution_context> @./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-finalization/04-CONTEXT.md
@.planning/phases/04-finalization/04-RESEARCH.md
@src/routes/rss.xml/+server.ts
@src/lib/sanity/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @portabletext/to-html and create RSS query</name>
  <files>package.json, src/lib/sanity/queries.ts</files>
  <action>
1. Install @portabletext/to-html:
   ```bash
   npm install @portabletext/to-html
   ```

2.  Add rssPostsQuery to src/lib/sanity/queries.ts - must include body field with full markDefs
    dereferencing (same pattern as postBySlugQuery):
    ```typescript
    export const rssPostsQuery = defineQuery(`
      *[_type == "post" && !hidden] | order(date desc) {
        _id,
        title,
        "slug": slug.current,
        excerpt,
        date,
        body[]{
          ...,
          markDefs[]{
            ...,
            _type == "internalLink" => {
              ...,
              "reference": reference-> {
                _type,
                slug
              }
            }
          }
        },
        tags[]-> { name },
        author-> { name },
        coverImage { "url": asset->url }
      }
    `);
    ```
        </action>
        <verify>

- `npm list @portabletext/to-html` shows package installed
- `grep "rssPostsQuery" src/lib/sanity/queries.ts` finds the query
- Query includes `body[]` field with markDefs </verify> <done>@portabletext/to-html installed,
  rssPostsQuery defined with body field</done> </task>

<task type="auto">
  <name>Task 2: Update RSS route to render HTML body</name>
  <files>src/routes/rss.xml/+server.ts</files>
  <action>
1. Import toHTML from @portabletext/to-html and rssPostsQuery
2. Replace allPostsQuery with rssPostsQuery
3. Define RSS-specific Portable Text components for:
   - codeBlock: render as `<pre><code>{escaped code}</code></pre>`
   - portableImage: render as `<figure><img src="{url}" alt="{alt}" /></figure>`
   - callout: render as `<blockquote><p>{text}</p></blockquote>`
   - internalLink mark: render as `<a href="{siteBaseUrl}/{slug}">{children}</a>`
   - link mark: render as `<a href="{href}">{children}</a>`

4. Update renderPost to:
    - Use toHTML(post.body, { components: rssComponents }) instead of toPlainText
    - Add dc:creator tag with author name:
      `<dc:creator>${escapeXml(post.author?.name || 'Unknown')}</dc:creator>`
    - Keep existing media:thumbnail and media:content tags for cover images
    - Keep "read on site" link for full experience

5. Update type SanityPostForRss to include author field:
    ```typescript
    author?: { name: string };
    ```

Note: Escape all user content with escapeXml/encode before embedding in XML </action> <verify>

- `npm run build` succeeds without errors
- `npm run preview` and visit /rss.xml returns valid XML
- RSS feed shows 9 items (all blog posts)
- content:encoded contains HTML tags like `<pre>`, `<code>`, `<p>`, `<a>` (not escaped `&lt;`)
- dc:creator tags present with author names </verify> <done>RSS feed renders full HTML body content
  with author attribution</done> </task>

</tasks>

<verification>
1. Build succeeds: `npm run build`
2. RSS validates: Fetch /rss.xml and verify:
   - Valid XML structure
   - 9 items (all published posts)
   - Each item has dc:creator tag
   - content:encoded contains actual HTML (code blocks, paragraphs, links)
3. Feed reader test: Paste RSS URL into a feed reader and verify formatted content displays
</verification>

<success_criteria>

- RSS feed at /rss.xml returns valid XML with all 9 published blog posts
- content:encoded contains full HTML body, not plain text
- Code blocks render as pre/code tags
- Internal/external links resolve correctly in feed content
- dc:creator author tag present on each item </success_criteria>

<output>
After completion, create `.planning/phases/04-finalization/04-01-SUMMARY.md`
</output>
