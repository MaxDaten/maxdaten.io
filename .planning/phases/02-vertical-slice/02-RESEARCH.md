# Phase 2: Vertical Slice - Research

**Researched:** 2026-01-19 **Domain:** SvelteKit + Sanity CMS integration, Portable Text rendering,
responsive images **Confidence:** HIGH

## Summary

This phase integrates Sanity CMS content fetching into the existing SvelteKit blog. The standard
approach uses `@sanity/client` for GROQ queries, `@portabletext/svelte` for rendering rich text, and
`@sanity/image-url` for responsive images from Sanity CDN. The existing Vercel adapter already
supports SSR - no migration from static adapter needed.

The dual-source routing pattern (Sanity-first, markdown fallback) is straightforward: the `[slug]`
route's server load function queries Sanity first, then falls back to existing markdown loaders if
not found. Blog listings merge both sources, deduplicate by slug, and sort by date.

**Primary recommendation:** Use `@sanity/client` with typed GROQ queries via Sanity TypeGen,
`@portabletext/svelte` with custom components matching existing CodeBlock/Callout/MarkdownImage
patterns, and `@sanity/image-url` for CDN image URLs with LQIP from asset metadata.

## Standard Stack

The established libraries/tools for this domain:

### Core

| Library                | Version | Purpose                            | Why Standard                                      |
| ---------------------- | ------- | ---------------------------------- | ------------------------------------------------- |
| `@sanity/client`       | ^6.x    | GROQ queries, content fetching     | Official Sanity client, server-side compatible    |
| `@portabletext/svelte` | ^3.x    | Portable Text to Svelte components | Official renderer, Svelte 5 runes support         |
| `@sanity/image-url`    | ^1.x    | Image URL building with transforms | Official, handles hotspot/crop, responsive srcset |
| `groq`                 | ^3.x    | GROQ template literals             | TypeGen integration, type-safe queries            |

### Supporting

| Library | Version | Purpose                         | When to Use                                         |
| ------- | ------- | ------------------------------- | --------------------------------------------------- |
| `shiki` | ^3.7.0  | Server-side syntax highlighting | Already in use, reuse for Portable Text code blocks |

### Alternatives Considered

| Instead of        | Could Use               | Tradeoff                                                                          |
| ----------------- | ----------------------- | --------------------------------------------------------------------------------- |
| `@sanity/client`  | `@sanity/svelte-loader` | Loader adds Visual Editing support but adds complexity; not needed for this phase |
| Manual image URLs | `sanity-image` (React)  | No Svelte equivalent; manual URL building is straightforward                      |

**Installation:**

```bash
npm install @sanity/client @portabletext/svelte @sanity/image-url groq
```

## Architecture Patterns

### Recommended Project Structure

```
src/
├── lib/
│   ├── sanity/
│   │   ├── client.ts           # Sanity client configuration
│   │   ├── queries.ts          # GROQ queries with defineQuery
│   │   ├── image.ts            # Image URL builder helper
│   │   └── portable-text/      # Custom PT components
│   │       ├── index.ts        # Component map export
│   │       ├── CodeBlock.svelte
│   │       ├── Callout.svelte
│   │       ├── PortableImage.svelte
│   │       └── InternalLink.svelte
│   ├── server/
│   │   └── posts.ts            # Existing - extend for dual-source
│   └── data/
│       └── posts.ts            # Existing - keep as fallback
├── routes/
│   ├── [slug]/
│   │   └── +page.server.ts     # Modify for Sanity-first
│   └── blog/
│       └── +page.server.ts     # Modify for merged listings
└── sanity.types.ts             # Generated by TypeGen
```

### Pattern 1: Sanity Client Setup

**What:** Configure Sanity client for server-side use with environment variables **When to use:**
All Sanity data fetching **Example:**

```typescript
// src/lib/sanity/client.ts
import { createClient } from '@sanity/client';
import { SANITY_API_TOKEN } from '$env/static/private';
import { PUBLIC_SANITY_PROJECT_ID, PUBLIC_SANITY_DATASET } from '$env/static/public';

export const client = createClient({
    projectId: PUBLIC_SANITY_PROJECT_ID,
    dataset: PUBLIC_SANITY_DATASET,
    apiVersion: '2025-02-19', // Use latest API version
    useCdn: true, // CDN for published content
    token: SANITY_API_TOKEN, // Optional: for draft preview
    perspective: 'published', // Default to published content
});

// For preview mode - fetches drafts
export const previewClient = client.withConfig({
    useCdn: false,
    perspective: 'previewDrafts',
});
```

### Pattern 2: Typed GROQ Queries

**What:** Define GROQ queries with `defineQuery` for automatic type inference **When to use:** All
content queries **Example:**

```typescript
// src/lib/sanity/queries.ts
import { defineQuery } from 'groq';

export const postBySlugQuery = defineQuery(`
  *[_type == "post" && slug.current == $slug][0] {
    _id,
    title,
    "slug": slug.current,
    excerpt,
    body,
    date,
    lastModified,
    hidden,
    "author": author-> {
      name,
      "image": image.asset->url
    },
    "tags": tags[]->{ name, "slug": slug.current },
    "keywords": keywords,
    "coverImage": coverImage {
      alt,
      caption,
      "url": asset->url,
      "lqip": asset->metadata.lqip,
      "dimensions": asset->metadata.dimensions,
      hotspot,
      crop
    }
  }
`);

export const allPostsQuery = defineQuery(`
  *[_type == "post" && !hidden] | order(date desc) {
    _id,
    title,
    "slug": slug.current,
    excerpt,
    date,
    "tags": tags[]->{ name, "slug": slug.current },
    "coverImage": coverImage {
      alt,
      "url": asset->url,
      "lqip": asset->metadata.lqip,
      "dimensions": asset->metadata.dimensions
    }
  }
`);
```

### Pattern 3: Dual-Source Route Loading

**What:** Query Sanity first, fall back to markdown if not found **When to use:** `[slug]` route
during migration period **Example:**

```typescript
// src/routes/[slug]/+page.server.ts
import type { PageServerLoad } from './$types';
import { client } from '$lib/sanity/client';
import { postBySlugQuery } from '$lib/sanity/queries';
import { importPostBySlug } from '$lib/server/posts';
import { error } from '@sveltejs/kit';

export const load: PageServerLoad = async ({ params }) => {
    // Try Sanity first
    const sanityPost = await client.fetch(postBySlugQuery, { slug: params.slug });

    if (sanityPost) {
        return {
            source: 'sanity' as const,
            post: sanityPost,
        };
    }

    // Fall back to markdown
    try {
        const mdPost = await importPostBySlug(params.slug);
        return {
            source: 'markdown' as const,
            post: mdPost,
        };
    } catch {
        throw error(404, 'Post not found');
    }
};
```

### Pattern 4: Portable Text Custom Components

**What:** Map Sanity block types to existing Svelte components **When to use:** Rendering body
content from Sanity **Example:**

```typescript
// src/lib/sanity/portable-text/index.ts
import CodeBlock from './CodeBlock.svelte';
import Callout from './Callout.svelte';
import PortableImage from './PortableImage.svelte';
import InternalLink from './InternalLink.svelte';

export const portableTextComponents = {
    types: {
        codeBlock: CodeBlock,
        callout: Callout,
        portableImage: PortableImage,
    },
    marks: {
        internalLink: InternalLink,
        link: ExternalLink,
    },
};
```

### Pattern 5: Image URL Building with LQIP

**What:** Generate responsive image URLs from Sanity CDN **When to use:** All Sanity images (cover,
inline) **Example:**

```typescript
// src/lib/sanity/image.ts
import imageUrlBuilder from '@sanity/image-url';
import { client } from './client';

const builder = imageUrlBuilder(client);

export function urlFor(source: SanityImageSource) {
    return builder.image(source);
}

// Generate srcset for responsive images
export function generateSrcSet(
    source: SanityImageSource,
    sizes: number[] = [320, 640, 960, 1280, 1920]
) {
    return sizes.map((w) => `${urlFor(source).width(w).auto('format').url()} ${w}w`).join(', ');
}
```

### Anti-Patterns to Avoid

- **Inline GROQ queries:** Always use `defineQuery` for type safety
- **Client-side Sanity fetching:** Keep all fetching server-side for security/performance
- **Ignoring hotspot/crop:** Always pass through to `@sanity/image-url` builder
- **Hardcoding image URLs:** Always use the URL builder for proper CDN transforms

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem                 | Don't Build               | Use Instead                    | Why                                        |
| ----------------------- | ------------------------- | ------------------------------ | ------------------------------------------ |
| Portable Text rendering | Custom recursive renderer | `@portabletext/svelte`         | Handles edge cases, marks, nested blocks   |
| Image URL transforms    | String concatenation      | `@sanity/image-url`            | Handles hotspot/crop math, proper encoding |
| GROQ type inference     | Manual TypeScript types   | Sanity TypeGen                 | Stays in sync with schema changes          |
| LQIP placeholders       | Generate at build time    | `asset->metadata.lqip` in GROQ | Sanity auto-generates 20px base64          |
| Syntax highlighting     | Runtime highlighting      | Shiki at render time           | Already in codebase, server-side           |

**Key insight:** Sanity's ecosystem handles image optimization (CDN), content typing (TypeGen), and
rich text complexity (Portable Text spec). Building custom solutions misses edge cases and creates
maintenance burden.

## Common Pitfalls

### Pitfall 1: Forgetting GROQ API Version

**What goes wrong:** Query behavior changes unexpectedly; reference dereferencing returns null **Why
it happens:** Default API perspective changed in 2025-02-19 version **How to avoid:** Always set
explicit `apiVersion` in client config; use `'2025-02-19'` or later **Warning signs:** References
returning null, drafts not appearing in preview mode

### Pitfall 2: SSR Whitespace Issues with Portable Text

**What goes wrong:** Marks (bold, links) render without surrounding spaces **Why it happens:**
Svelte SSR strips whitespace between components **How to avoid:** Test rendering carefully; known
issue in `@portabletext/svelte` **Warning signs:** Words running together in rendered output

### Pitfall 3: Missing LQIP Metadata

**What goes wrong:** Image placeholders don't load; `lqip` is undefined **Why it happens:** Image
uploaded before LQIP was enabled in schema, or custom metadata config **How to avoid:** Fetch via
`asset->metadata.lqip`; handle undefined gracefully **Warning signs:** Check existing Sanity images
via Vision tool

### Pitfall 4: Prerendering with Dynamic Content

**What goes wrong:** Content changes don't appear until rebuild **Why it happens:** Route marked as
`prerender = true` bypasses SSR **How to avoid:** Remove `prerender` from dynamic Sanity routes; use
ISR if caching needed **Warning signs:** Old content showing after publish

### Pitfall 5: Environment Variable Exposure

**What goes wrong:** API token visible in client bundle **Why it happens:** Using `PUBLIC_` prefix
or `$env/dynamic/public` **How to avoid:** Token in `$env/static/private`; never prefix with
`PUBLIC_` **Warning signs:** Token visible in browser network tab or page source

### Pitfall 6: Dual-Source Related Posts Complexity

**What goes wrong:** Related posts algorithm becomes complex mixing sources **Why it happens:**
Trying to suggest markdown posts from Sanity posts or vice versa **How to avoid:** Same-source only
during migration (per CONTEXT.md decision) **Warning signs:** Complex join logic, performance issues

## Code Examples

Verified patterns from official sources:

### Portable Text Code Block Component

```svelte
<!-- src/lib/sanity/portable-text/CodeBlock.svelte -->
<script lang="ts">
    import type { CustomBlockComponentProps } from '@portabletext/svelte';
    import CodeBlockUI from '$components/molecules/CodeBlock.svelte';
    import { codeToHtml } from 'shiki';

    interface CodeBlockValue {
        code: string;
        language?: string;
        filename?: string;
        showLineNumbers?: boolean;
        highlightedLines?: string;
    }

    interface Props {
        portableText: CustomBlockComponentProps<CodeBlockValue>;
    }

    let { portableText }: Props = $props();
    let { value } = $derived(portableText);

    // Use Shiki for syntax highlighting (server-side)
    let highlightedHtml = $derived.by(async () => {
        return await codeToHtml(value.code, {
            lang: value.language || 'text',
            theme: 'ayu-dark',
        });
    });
</script>

<CodeBlockUI
    filename={value.filename}
    showLineNumbers={value.showLineNumbers ?? false}
    lang={value.language}
>
    {@html highlightedHtml}
</CodeBlockUI>
```

### Portable Image Component with LQIP

```svelte
<!-- src/lib/sanity/portable-text/PortableImage.svelte -->
<script lang="ts">
    import type { CustomBlockComponentProps } from '@portabletext/svelte';
    import { urlFor, generateSrcSet } from '$lib/sanity/image';

    interface ImageValue {
        image: {
            asset: { _ref: string };
            hotspot?: { x: number; y: number };
            crop?: { top: number; bottom: number; left: number; right: number };
        };
        alt: string;
        caption?: string;
    }

    interface Props {
        portableText: CustomBlockComponentProps<ImageValue>;
        lqip?: string;
    }

    let { portableText, lqip }: Props = $props();
    let { value } = $derived(portableText);

    const sizes = [320, 640, 960, 1280, 1920];
    const srcset = $derived(generateSrcSet(value.image, sizes));
    const src = $derived(urlFor(value.image).width(1280).auto('format').url());
</script>

<figure>
    <img
        {src}
        {srcset}
        sizes="(max-width: 640px) 100vw, (max-width: 1280px) 80vw, 1280px"
        alt={value.alt}
        loading="lazy"
        style:background-image={lqip ? `url(${lqip})` : undefined}
        style:background-size="cover"
    />
    {#if value.caption}
        <figcaption>{value.caption}</figcaption>
    {/if}
</figure>
```

### Merged Blog Listing Query

```typescript
// src/routes/blog/+page.server.ts
import type { PageServerLoad } from './$types';
import { client } from '$lib/sanity/client';
import { allPostsQuery } from '$lib/sanity/queries';
import { filteredPosts as markdownPosts } from '$lib/server/posts';

export const load: PageServerLoad = async () => {
    const sanityPosts = await client.fetch(allPostsQuery);

    // Merge and deduplicate by slug (Sanity wins)
    const sanitySlugSet = new Set(sanityPosts.map((p) => p.slug));
    const mdFiltered = markdownPosts.filter((p) => !sanitySlugSet.has(p.slug));

    const allPosts = [...sanityPosts, ...mdFiltered].sort(
        (a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()
    );

    return { posts: allPosts };
};
```

### Internal Link Mark Component

```svelte
<!-- src/lib/sanity/portable-text/InternalLink.svelte -->
<script lang="ts">
    import type { MarkComponentProps } from '@portabletext/svelte';
    import type { Snippet } from 'svelte';

    interface InternalLinkValue {
        reference?: {
            _type: 'post' | 'gem';
            slug: { current: string };
        };
    }

    interface Props {
        portableText: MarkComponentProps<InternalLinkValue>;
        children: Snippet;
    }

    let { portableText, children }: Props = $props();
    let { value } = $derived(portableText);

    // Resolve reference to URL at render time
    const href = $derived(() => {
        if (!value.reference) return '#';
        const { _type, slug } = value.reference;
        return _type === 'post' ? `/${slug.current}` : `/gems#${slug.current}`;
    });
</script>

<a href={href()}>
    {@render children()}
</a>
```

## State of the Art

| Old Approach                     | Current Approach           | When Changed   | Impact                                       |
| -------------------------------- | -------------------------- | -------------- | -------------------------------------------- |
| `sanity-codegen`                 | Sanity TypeGen             | 2024           | TypeGen is official, maintained by GROQ team |
| `perspective: 'raw'` default     | `perspective: 'published'` | API 2025-02-19 | Must set explicitly for drafts               |
| `@sanity/svelte-loader` required | Direct `@sanity/client`    | N/A            | Loader optional unless using Visual Editing  |
| Svelte 4 slots                   | Svelte 5 snippets          | 2024           | `@portabletext/svelte` v3 uses runes         |

**Deprecated/outdated:**

- `sanity-codegen`: Use Sanity TypeGen instead
- `sanity.types.ts` in `sanity-typegen.json`: Configure in `sanity.cli.ts` as of CLI 4.19.0
- Svelte 4 slot syntax: `@portabletext/svelte` v3 requires Svelte 5 runes

## Open Questions

Things that couldn't be fully resolved:

1. **SSR whitespace bug in @portabletext/svelte**
    - What we know: Known issue (#1 on GitHub), affects mark rendering
    - What's unclear: Whether it affects this specific use case; severity
    - Recommendation: Test early with representative content; may need CSS workaround

2. **Shiki async highlighting in Portable Text components**
    - What we know: `codeToHtml` is async; Svelte 5 `$derived` handles promises
    - What's unclear: Best pattern for SSR with async derived values
    - Recommendation: May need to pre-highlight in server load or use streaming

3. **TypeGen workspace configuration**
    - What we know: TypeGen configured in `sanity.cli.ts`; schema extraction required
    - What's unclear: How to share types between `studio/` and main SvelteKit app
    - Recommendation: May need to run TypeGen in studio, copy types, or use workspace

## Sources

### Primary (HIGH confidence)

- [Sanity TypeGen Documentation](https://www.sanity.io/docs/apis-and-sdks/sanity-typegen) - Setup,
  defineQuery, type generation
- [Sanity Image Transformations](https://www.sanity.io/docs/apis-and-sdks/image-urls) - URL
  parameters, transforms
- [Sanity Presenting Images](https://www.sanity.io/docs/apis-and-sdks/presenting-images) -
  @sanity/image-url, srcset, LQIP
- [SvelteKit Vercel Adapter](https://svelte.dev/docs/kit/adapter-vercel) - SSR, ISR, config options
- [GitHub: portabletext/svelte-portabletext](https://github.com/portabletext/svelte-portabletext) -
  API, custom components, Svelte 5

### Secondary (MEDIUM confidence)

- [Visual Editing with SvelteKit](https://www.sanity.io/docs/visual-editing/visual-editing-with-sveltekit) -
  @sanity/svelte-loader setup
- [GROQ Query Cheat Sheet](https://www.sanity.io/docs/content-lake/query-cheat-sheet) - Reference
  expansion patterns
- [Sanity Image Metadata](https://www.sanity.io/docs/apis-and-sdks/image-metadata) - LQIP, blurhash
  fetching

### Tertiary (LOW confidence)

- WebSearch results on dual-source patterns - No authoritative pattern documented; custom
  implementation needed
- Community blog posts on SvelteKit + Sanity - Individual implementations, may not match current
  versions

## Metadata

**Confidence breakdown:**

- Standard stack: HIGH - Official Sanity packages, well-documented
- Architecture: HIGH - Patterns from official docs and existing codebase
- Dual-source routing: MEDIUM - Custom pattern, no official guidance
- Pitfalls: MEDIUM - Mix of documented issues and community reports
- Portable Text SSR: LOW - Known bug, unclear impact

**Research date:** 2026-01-19 **Valid until:** 2026-02-19 (30 days - stable ecosystem, but check
TypeGen/API versions)
