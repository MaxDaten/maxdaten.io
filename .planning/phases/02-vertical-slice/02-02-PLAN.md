---
phase: 02-vertical-slice
plan: 02
type: execute
wave: 2
depends_on: ['02-01']
files_modified:
    - src/lib/sanity/portable-text/index.ts
    - src/lib/sanity/portable-text/CodeBlock.svelte
    - src/lib/sanity/portable-text/Callout.svelte
    - src/lib/sanity/portable-text/PortableImage.svelte
    - src/lib/sanity/portable-text/InternalLink.svelte
    - src/lib/sanity/portable-text/ExternalLink.svelte
    - src/lib/sanity/portable-text/Heading.svelte
autonomous: true

must_haves:
    truths:
        - 'Code blocks render with syntax highlighting matching existing blog appearance'
        - 'Callouts display with info/warning/tip styling'
        - 'Images show with LQIP placeholders and responsive srcset'
        - 'Internal links resolve to correct post/gem URLs'
        - 'External links open in new tab with noopener'
        - 'Headings have anchor links with hover icon'
    artifacts:
        - path: 'src/lib/sanity/portable-text/index.ts'
          provides: 'Component map for @portabletext/svelte'
          exports: ['portableTextComponents']
        - path: 'src/lib/sanity/portable-text/CodeBlock.svelte'
          provides: 'Code block renderer using Shiki'
          min_lines: 30
        - path: 'src/lib/sanity/portable-text/PortableImage.svelte'
          provides: 'Image renderer with LQIP and srcset'
          min_lines: 25
    key_links:
        - from: 'src/lib/sanity/portable-text/CodeBlock.svelte'
          to: '$components/molecules/CodeBlock.svelte'
          via: 'wraps existing component'
          pattern: 'import.*CodeBlock.*molecules'
        - from: 'src/lib/sanity/portable-text/PortableImage.svelte'
          to: '$lib/sanity/image.ts'
          via: 'uses urlFor and generateSrcSet'
          pattern: 'import.*urlFor.*image'
---

<objective>
Create Portable Text rendering components for Sanity content.

Purpose: Map Sanity block types to Svelte components that match the existing blog styling. Code
blocks reuse the existing CodeBlock component with Shiki highlighting. Images use the Sanity image
URL builder for responsive loading with LQIP placeholders.

Output: Complete component set for rendering Portable Text body content from Sanity posts.
</objective>

<execution_context> @./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-vertical-slice/02-CONTEXT.md
@.planning/phases/02-vertical-slice/02-RESEARCH.md
@.planning/phases/02-vertical-slice/02-01-SUMMARY.md

# Existing components to reference/wrap

@src/lib/components/molecules/CodeBlock.svelte @src/lib/shiki/transformerCodeBlock.js

# Schema definitions for data shapes

@studio/schemas/objects/codeBlock.ts @studio/schemas/objects/callout.ts
@studio/schemas/objects/portableImage.ts </context>

<tasks>

<task type="auto">
  <name>Task 1: Create CodeBlock and Callout components</name>
  <files>src/lib/sanity/portable-text/CodeBlock.svelte, src/lib/sanity/portable-text/Callout.svelte</files>
  <action>
Create `src/lib/sanity/portable-text/CodeBlock.svelte`:

Props interface for Portable Text custom block:

```typescript
interface Props {
    portableText: CustomBlockComponentProps<{
        code: string;
        language?: string;
        filename?: string;
        showLineNumbers?: boolean;
        highlightedLines?: string;
    }>;
}
```

Implementation:

- Destructure `value` from portableText prop using $derived
- Use Shiki's `codeToHtml` for syntax highlighting (import from 'shiki')
- Wrap result in existing `$components/molecules/CodeBlock.svelte` for consistent styling
- Pass filename, showLineNumbers, and lang to the wrapper
- Handle async highlighting with {#await} block or $effect
- Use 'ayu-dark' theme to match existing blog

Note: The existing CodeBlock.svelte expects children as a snippet containing pre.shiki element.

Create `src/lib/sanity/portable-text/Callout.svelte`:

Props interface:

```typescript
interface Props {
    portableText: CustomBlockComponentProps<{
        type: 'info' | 'warning' | 'tip';
        content: PortableTextBlock[];
    }>;
}
```

Implementation:

- Display callout with colored border/background based on type
- Use CSS variables for theme consistency
- Render nested content using PortableText component recursively
- Match styling to existing markdown callout appearance (see blog posts with [!NOTE] syntax)
  </action> <verify>
- `npx tsc --noEmit` passes
- Both files exist and export default component
- CodeBlock imports from $components/molecules/CodeBlock.svelte </verify> <done> CodeBlock renders
  syntax-highlighted code matching existing blog styling. Callout renders info/warning/tip blocks
  with appropriate visual treatment. </done> </task>

<task type="auto">
  <name>Task 2: Create PortableImage and link components</name>
  <files>src/lib/sanity/portable-text/PortableImage.svelte, src/lib/sanity/portable-text/InternalLink.svelte, src/lib/sanity/portable-text/ExternalLink.svelte</files>
  <action>
Create `src/lib/sanity/portable-text/PortableImage.svelte`:

Props interface:

```typescript
interface Props {
  portableText: CustomBlockComponentProps<{
    image: { asset: { _ref: string }; hotspot?: {...}; crop?: {...} };
    alt: string;
    caption?: string;
  }>;
  lqip?: string; // Passed from parent if available
}
```

Implementation:

- Import urlFor and generateSrcSet from $lib/sanity/image
- Generate srcset for responsive sizes [320, 640, 960, 1280, 1920]
- Default src at 1280px width with auto format
- Apply LQIP as background-image placeholder (from asset->metadata.lqip in query)
- Use loading="lazy" for below-fold images
- Wrap in figure with optional figcaption for caption
- sizes attribute: "(max-width: 640px) 100vw, (max-width: 1280px) 80vw, 1280px"

Create `src/lib/sanity/portable-text/InternalLink.svelte`:

Props interface (mark component):

```typescript
interface Props {
    portableText: MarkComponentProps<{
        reference?: { _type: 'post' | 'gem'; slug: { current: string } };
    }>;
    children: Snippet;
}
```

Implementation:

- Resolve reference to URL at render time
- Posts: `/${slug.current}`
- Gems: `/gems#${slug.current}`
- Return anchor tag wrapping children snippet
- Handle missing reference gracefully (return span)

Create `src/lib/sanity/portable-text/ExternalLink.svelte`:

Props interface (mark component for standard links):

```typescript
interface Props {
    portableText: MarkComponentProps<{ href: string }>;
    children: Snippet;
}
```

Implementation:

- Per CONTEXT.md: target="\_blank" and rel="noopener" for external links
- Render anchor tag with href from value </action> <verify>
- `npx tsc --noEmit` passes
- All three files exist
- PortableImage imports from $lib/sanity/image </verify> <done> Images render responsively with LQIP
  placeholders. Links properly resolve to internal routes or open external URLs in new tabs. </done>
  </task>

<task type="auto">
  <name>Task 3: Create Heading component and assemble component map</name>
  <files>src/lib/sanity/portable-text/Heading.svelte, src/lib/sanity/portable-text/index.ts</files>
  <action>
Create `src/lib/sanity/portable-text/Heading.svelte`:

Per CONTEXT.md: "Heading anchors: Yes, with hover icon for copying URL"

Props interface (block component):

```typescript
interface Props {
    portableText: CustomBlockComponentProps;
    children: Snippet;
}
```

Implementation:

- Extract heading level from portableText.value.style (h1, h2, h3, etc.)
- Generate slug from text content (lowercase, replace spaces with hyphens)
- Render appropriate heading tag with id attribute
- Add anchor link that appears on hover
- Use link icon (can use existing icon from $lib/icons or create simple SVG)
- Click copies URL with anchor to clipboard

Create `src/lib/sanity/portable-text/index.ts`:

Export portableTextComponents object for @portabletext/svelte:

```typescript
export const portableTextComponents = {
    types: {
        codeBlock: CodeBlock,
        callout: Callout,
        portableImage: PortableImage,
        youtubeEmbed: YoutubeEmbed, // Optional: create if time permits, else skip
    },
    marks: {
        internalLink: InternalLink,
        link: ExternalLink,
    },
    block: {
        h1: Heading,
        h2: Heading,
        h3: Heading,
        h4: Heading,
        h5: Heading,
        h6: Heading,
    },
};
```

Note: For youtubeEmbed, create a simple iframe embed if straightforward, otherwise defer to Phase 3.
</action> <verify>

- `npx tsc --noEmit` passes
- index.ts exports portableTextComponents
- All component imports resolve </verify> <done> Complete Portable Text component map ready for use
  with @portabletext/svelte. Headings have copyable anchor links. </done> </task>

</tasks>

<verification>
After all tasks complete:

1. Run type check: `npm run check` passes
2. Verify component map structure:
    - `grep -q "portableTextComponents" src/lib/sanity/portable-text/index.ts`
    - `grep -q "codeBlock" src/lib/sanity/portable-text/index.ts`
3. Verify key imports:
    - CodeBlock wraps existing component
    - PortableImage uses image URL builder </verification>

<success_criteria>

- All Portable Text components created
- CodeBlock reuses existing molecule for consistent styling
- PortableImage generates responsive srcset with LQIP
- InternalLink resolves post/gem references to URLs
- ExternalLink opens in new tab
- Headings have anchor links
- Component map exported for @portabletext/svelte
- TypeScript compilation passes </success_criteria>

<output>
After completion, create `.planning/phases/02-vertical-slice/02-02-SUMMARY.md`
</output>
