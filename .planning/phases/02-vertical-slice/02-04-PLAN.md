---
phase: 02-vertical-slice
plan: 04
type: execute
wave: 4
depends_on: ['02-03']
files_modified: []
autonomous: false

must_haves:
    truths:
        - 'Migrated blog post renders correctly at its original URL'
        - 'Code blocks display with syntax highlighting and filename'
        - 'Images load from Sanity CDN with responsive sizes'
        - 'Post appears in blog listing alongside markdown posts'
        - 'Production deployment serves Sanity content'
    artifacts:
        - path: 'Sanity Studio content'
          provides: 'One complete blog post in Sanity CMS'
          contains: 'post document with body, cover image, tags'
    key_links:
        - from: 'maxdaten.io/[migrated-slug]'
          to: 'Sanity API'
          via: 'server-side fetch'
          pattern: 'source.*sanity'
---

<objective>
Migrate one blog post to Sanity and verify production deployment.

Purpose: Complete the vertical slice by migrating a real blog post that exercises code blocks,
images, and rich formatting. Deploy to production and verify the full integration works end-to-end.

Output: One blog post fully served from Sanity CMS, live in production, rendering identically to the
markdown version. </objective>

<execution_context> @./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-vertical-slice/02-CONTEXT.md
@.planning/phases/02-vertical-slice/02-03-SUMMARY.md

# Candidate posts for migration (complex, good test cases)

@src/content/blog/2025-09-03-tdd-infrastructure-terragrunt.md
@src/content/blog/2024-05-15-telepresence-google-cloud-kubernetes-engine-gke.md </context>

<tasks>

<task type="auto">
  <name>Task 1: Select and migrate blog post to Sanity</name>
  <files>None (Sanity Studio content)</files>
  <action>
Select a blog post that exercises most features. Good candidates:
- `2025-09-03-tdd-infrastructure-terragrunt.md` - Has code blocks (HCL, Bash), images (SVG diagram), callouts
- `2024-05-15-telepresence-google-cloud-kubernetes-engine-gke.md` - Has code blocks (YAML), callouts (WARNING, TIP)

Migrate the selected post to Sanity Studio at https://maxdaten.sanity.studio:

1. Create a new Post document
2. Copy frontmatter fields:
    - title
    - slug (MUST match exactly: e.g., `2025-09-03-tdd-infrastructure-terragrunt`)
    - excerpt
    - date (keep original)
    - hidden: false
    - keywords
3. Assign author (create jloos author if not exists)
4. Create and assign tags (create tag documents if not exists)
5. Upload cover image if the post has one (check src/lib/assets/images/posts/[slug]/)
6. Convert markdown body to Portable Text:
    - Regular paragraphs as block type
    - Code blocks: use codeBlock type with language, filename (from ```lang filename= syntax),
      showLineNumbers
    - Images: upload to Sanity, use portableImage type with alt text
    - Callouts: use callout type with appropriate type (info/warning/tip from
      [!NOTE]/[!WARNING]/[!TIP])
    - Links: external links as standard marks, internal post refs as internalLink

Note: This is manual content entry in Sanity Studio. Future migration scripts (Phase 3) will
automate this. </action> <verify>

- Post exists in Sanity Studio
- Slug matches original markdown post slug exactly
- All code blocks have correct language and filename
- All images uploaded and referenced </verify> <done> Complete blog post migrated to Sanity with all
  content elements: body, code blocks, images, callouts, metadata. </done> </task>

<task type="auto">
  <name>Task 2: Set environment variables and deploy</name>
  <files>.env (local), Vercel environment variables</files>
  <action>
Set up environment variables for Sanity integration:

Local development (.env file, not committed):

```
PUBLIC_SANITY_PROJECT_ID=<project-id-from-studio/sanity.cli.ts>
PUBLIC_SANITY_DATASET=production
SANITY_PREVIEW_SECRET=<generate-random-secret>
```

Vercel production:

1. Go to Vercel project settings > Environment Variables
2. Add PUBLIC_SANITY_PROJECT_ID (visible to browser - PUBLIC prefix)
3. Add PUBLIC_SANITY_DATASET (visible to browser)
4. Add SANITY_PREVIEW_SECRET (server-only, no PUBLIC prefix)

Then deploy:

```bash
vercel --prod
```

Or if using git-based deployments, push to main and let Vercel auto-deploy. </action> <verify>

- Local `npm run dev` starts without errors
- Visiting localhost:5173/[migrated-slug] loads post from Sanity
- Vercel deployment completes successfully </verify> <done> Environment configured locally and in
  Vercel. Production deployment triggered. </done> </task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify production deployment</name>
  <what-built>
Complete vertical slice: Sanity integration with one migrated blog post deployed to production.
  </what-built>
  <how-to-verify>
1. **Blog Listing** (https://maxdaten.io/blog):
   - Migrated post appears in the list alongside markdown posts
   - Cover image loads (if post has one)
   - Excerpt displays correctly
   - Clicking navigates to post

2. **Post Page** (https://maxdaten.io/[migrated-slug]):
    - Title, date, author display correctly
    - Cover image loads from Sanity CDN (check Network tab for cdn.sanity.io)
    - Code blocks:
        - Syntax highlighting works
        - Filename header shows (if present in source)
        - Copy button works
    - Callouts:
        - Display with appropriate styling
        - Background color matches type (info/warning/tip)
    - Images in body:
        - Load from Sanity CDN
        - Responsive (check different viewport sizes)
    - Links work (internal and external)
    - Heading anchors appear on hover

3. **Markdown Post** (https://maxdaten.io/[any-other-slug]):
    - Still works unchanged (loads from markdown)
    - Verify at least one other post renders correctly

4. **Preview Mode** (optional):
    - Add ?preview=<secret> to migrated post URL
    - Should still load (verifies preview client works) </how-to-verify> <resume-signal> Type
      "approved" if all checks pass, or describe any issues found. </resume-signal> </task>

</tasks>

<verification>
Phase 2 Vertical Slice verification:

1. **SLCE-01** (Vercel adapter): Already complete from Phase 1
2. **SLCE-02** (Fetch posts from Sanity): Migrated post loads from Sanity
3. **SLCE-03** (Fetch gems from Sanity): Deferred to Phase 3 (per CONTEXT.md)
4. **SLCE-04** (Portable Text renders): Code blocks, callouts, images render correctly
5. **SLCE-05** (Images from Sanity CDN): Check Network tab for cdn.sanity.io
6. **SLCE-06** (Dual-source routing): Sanity post loads, markdown posts still work
7. **SLCE-07** (Migrate one post): Complete
8. **SLCE-08** (Deploy and verify): Production verified </verification>

<success_criteria>

- One blog post fully migrated to Sanity
- Post renders correctly at original URL
- Code blocks have syntax highlighting
- Images load from Sanity CDN
- Blog listing shows merged posts
- Production deployment works
- Markdown posts unaffected
- Human verification passed </success_criteria>

<output>
After completion, create `.planning/phases/02-vertical-slice/02-04-SUMMARY.md`
</output>
