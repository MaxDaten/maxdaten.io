---
phase: 02-vertical-slice
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
    - package.json
    - src/lib/sanity/client.ts
    - src/lib/sanity/queries.ts
    - src/lib/sanity/image.ts
    - .env.example
autonomous: true

must_haves:
    truths:
        - 'Sanity client can fetch published content from maxdaten dataset'
        - 'GROQ queries return typed post and listing data'
        - 'Image URLs can be generated with responsive srcset'
    artifacts:
        - path: 'src/lib/sanity/client.ts'
          provides: 'Sanity client with CDN and preview configurations'
          exports: ['client', 'previewClient']
        - path: 'src/lib/sanity/queries.ts'
          provides: 'GROQ queries for posts and listings'
          exports: ['postBySlugQuery', 'allPostsQuery']
        - path: 'src/lib/sanity/image.ts'
          provides: 'Image URL builder with srcset generation'
          exports: ['urlFor', 'generateSrcSet']
    key_links:
        - from: 'src/lib/sanity/client.ts'
          to: '@sanity/client'
          via: 'createClient import'
          pattern: 'import.*createClient.*@sanity/client'
        - from: 'src/lib/sanity/queries.ts'
          to: 'groq'
          via: 'defineQuery template literals'
          pattern: 'defineQuery'
---

<objective>
Set up Sanity client infrastructure for fetching content from the CMS.

Purpose: Establish the foundation for all Sanity data fetching - client configuration, typed GROQ
queries, and image URL building. This enables subsequent plans to fetch and render Sanity content.

Output: Working Sanity client with queries that can fetch posts by slug and list all posts, plus
image URL builder for responsive images. </objective>

<execution_context> @./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-vertical-slice/02-CONTEXT.md
@.planning/phases/02-vertical-slice/02-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

# Existing Sanity config (for project ID reference)

@studio/sanity.cli.ts </context>

<tasks>

<task type="auto">
  <name>Task 1: Install Sanity packages and create client</name>
  <files>package.json, src/lib/sanity/client.ts, .env.example</files>
  <action>
Install required Sanity packages:
```bash
npm install @sanity/client @portabletext/svelte @sanity/image-url groq
```

Create `src/lib/sanity/client.ts`:

- Import createClient from @sanity/client
- Read project ID from PUBLIC_SANITY_PROJECT_ID (use same value as studio/sanity.cli.ts)
- Read dataset from PUBLIC_SANITY_DATASET (default 'production')
- Set apiVersion to '2025-02-19' (latest stable)
- Enable useCdn: true for published content
- Set perspective: 'published' as default
- Export `client` for normal fetching
- Export `previewClient` with useCdn: false and perspective: 'previewDrafts' for preview mode
- Token is optional (only needed for preview), read from SANITY_API_TOKEN if available

Create/update `.env.example` with:

- PUBLIC_SANITY_PROJECT_ID=your-project-id
- PUBLIC_SANITY_DATASET=production
- SANITY_API_TOKEN=optional-for-preview

Use $env/static/public for public vars, $env/static/private for token. </action> <verify>

- `npm ls @sanity/client` shows package installed
- `npx tsc --noEmit` passes (no type errors)
- File exists: src/lib/sanity/client.ts </verify> <done> Sanity client module exports client and
  previewClient, ready for use in server load functions. </done> </task>

<task type="auto">
  <name>Task 2: Create GROQ queries for posts</name>
  <files>src/lib/sanity/queries.ts</files>
  <action>
Create `src/lib/sanity/queries.ts` with typed GROQ queries using defineQuery from groq package.

Create `postBySlugQuery`:

- Filter: \*[\_type == "post" && slug.current == $slug][0]
- Fields: \_id, title, slug.current (as "slug"), excerpt, body (full Portable Text), date,
  lastModified, hidden
- Dereference author: author-> { name, "image": image.asset->url }
- Dereference tags: tags[]->{ name, "slug": slug.current }
- Include keywords array
- Expand coverImage: { alt, caption, "url": asset->url, "lqip": asset->metadata.lqip, "dimensions":
  asset->metadata.dimensions, hotspot, crop }

Create `allPostsQuery` for blog listing:

- Filter: \*[_type == "post" && !hidden] | order(date desc)
- Fields: \_id, title, slug.current (as "slug"), excerpt, date
- Dereference tags: tags[]->{ name, "slug": slug.current }
- Expand coverImage: { alt, "url": asset->url, "lqip": asset->metadata.lqip, "dimensions":
  asset->metadata.dimensions }
- Omit body (not needed for listing)

Export both queries as named exports. </action> <verify>

- `npx tsc --noEmit` passes
- File exports postBySlugQuery and allPostsQuery </verify> <done> GROQ queries ready for use in
  route load functions, with proper field projection for single post and listing views. </done>
  </task>

<task type="auto">
  <name>Task 3: Create image URL builder</name>
  <files>src/lib/sanity/image.ts</files>
  <action>
Create `src/lib/sanity/image.ts`:

Import imageUrlBuilder from @sanity/image-url Import client from ./client

Initialize builder: `const builder = imageUrlBuilder(client)`

Create `urlFor(source: SanityImageSource)` function:

- Returns builder.image(source) for chaining
- Type SanityImageSource from @sanity/image-url/lib/types/types

Create `generateSrcSet(source, sizes = [320, 640, 960, 1280, 1920])` function:

- Maps sizes to srcset entries: `${urlFor(source).width(w).auto('format').url()} ${w}w`
- Joins with ', '
- auto('format') enables WebP/AVIF based on browser support

Export urlFor and generateSrcSet.

Note: The sizes array matches CONTEXT.md responsive breakpoints decision. </action> <verify>

- `npx tsc --noEmit` passes
- File exports urlFor and generateSrcSet functions </verify> <done> Image URL builder ready for
  generating responsive srcset from Sanity image references, with automatic format negotiation.
  </done> </task>

</tasks>

<verification>
After all tasks complete:

1. Run type check: `npm run check` passes
2. Verify exports by grepping:
    - `grep -q "export.*client" src/lib/sanity/client.ts`
    - `grep -q "export.*postBySlugQuery" src/lib/sanity/queries.ts`
    - `grep -q "export.*urlFor" src/lib/sanity/image.ts`
3. Packages installed: `npm ls @sanity/client @portabletext/svelte @sanity/image-url groq`
   </verification>

<success_criteria>

- All Sanity packages installed
- Client module exports client and previewClient
- Queries module exports postBySlugQuery and allPostsQuery
- Image module exports urlFor and generateSrcSet
- TypeScript compilation passes
- .env.example documents required environment variables </success_criteria>

<output>
After completion, create `.planning/phases/02-vertical-slice/02-01-SUMMARY.md`
</output>
